<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#2c2c54" />
  <title>ê¹ƒí•˜ì´ë¼ì´íŠ¸</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
</head>
<body>
  <header>
    <div class="header-container">
      <button class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
      </button>
      <div class="logo-section">
        <h1><a href="/" class="logo-link">ğŸŒŸ ê¹ƒí•˜ì´ë¼ì´íŠ¸</a></h1>
        <p>ì „ ì„¸ê³„ ê°œë°œìë“¤ì´ ìŠ¤íƒ€ë¥¼ ëˆ„ë¥¸ GitHub ëª…ì‘,<br>ì•„ì´ë””ì–´ëŠ” ì´ì œ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤ - {{ today }}</p>
      </div>
      <nav class="main-nav" id="mainNav">
        <ul>
          <li><a href="/about" title="ì‚¬ì´íŠ¸ ì†Œê°œ"><i class="fas fa-info-circle"></i> ì†Œê°œ</a></li>
          {% if current_user.is_authenticated %}
            <li><a href="/bookmarks" title="ë‚´ ë¶ë§ˆí¬"><i class="fas fa-bookmark"></i> ë‚´ ë¶ë§ˆí¬</a></li>
            <li><a href="/logout" title="ë¡œê·¸ì•„ì›ƒ"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
          {% else %}
            <li><a href="/login" title="ë¡œê·¸ì¸"><i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸</a></li>
            <li><a href="/register" class="register-btn" title="íšŒì›ê°€ì…"><i class="fas fa-user-plus"></i> íšŒì›ê°€ì…</a></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </header>
  <main>
    {% for repo in repos %}
    <section class="card">
      <h2><a href="{{ repo.link }}" target="_blank">{{ repo.name }}</a></h2>
      <div class="stars-container">
        <span class="stars"><i class="fas fa-star"></i> {{ repo.stars }}</span>
      </div>
      <div class="summary-section">
        <p><strong class="summary-label">ìš”ì•½:</strong> {{ repo.summary }}</p>
        <p><strong class="feature-label">ê¸°ëŠ¥:</strong> {{ repo.feature }}</p>
      </div>
      <pre><code>{{ repo.code }}</code></pre>
      <div class="card-actions">
        {% if current_user.is_authenticated %}
          {% if repo.bookmarked %}
            <button class="bookmark-btn remove-bookmark" data-id="{{ repo.bookmark_id }}">
              <i class="fas fa-bookmark"></i> ë¶ë§ˆí¬ ì‚­ì œ
            </button>
          {% else %}
            <button class="bookmark-btn add-bookmark" data-name="{{ repo.name }}">
              <i class="far fa-bookmark"></i> ë¶ë§ˆí¬ ì¶”ê°€
            </button>
          {% endif %}
          
          <button class="comment-toggle" data-repo-id="{{ repo.id }}">
            <i class="fas fa-comments"></i> ëŒ“ê¸€ <span class="comment-count">{{ repo.comment_count }}</span>
          </button>
        {% else %}
          <button class="bookmark-btn need-login">
            <i class="far fa-bookmark"></i> ë¶ë§ˆí¬
          </button>
          <button class="comment-toggle need-login">
            <i class="fas fa-comments"></i> ëŒ“ê¸€
          </button>
        {% endif %}
      </div>
      
      <!-- ì ‘ì´ì‹ ëŒ“ê¸€ ì„¹ì…˜ -->
      {% if current_user.is_authenticated %}
      <div class="comments-section" style="display: none;" id="comments-{{ repo.id }}">
        <div class="comments-list">
          <!-- ëŒ“ê¸€ì€ JavaScriptë¡œ ë™ì  ë¡œë“œë©ë‹ˆë‹¤ -->
          <div class="loading-comments">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
        
        <div class="comment-form-container">
          <form class="comment-form" data-repo-id="{{ repo.id }}">
            <textarea placeholder="ì˜ê²¬ì´ë‚˜ ì§ˆë¬¸ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." required></textarea>
            <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
          </form>
        </div>
      </div>
      {% endif %}
    </section>
    {% endfor %}
  </main>
  <footer>
    <p>&copy; ê¹ƒí•˜ì´ë¼ì´íŠ¸ 2025 | <a href="https://github.com" target="_blank">GitHub</a>ì—ì„œ ë°œê²¬ëœ ë³´ì„ë“¤</p>
  </footer>
  
  <!-- ìœ„ë¡œ ê°€ê¸° ë²„íŠ¼ -->
  <button id="back-to-top" title="ë§¨ ìœ„ë¡œ ì´ë™" style="display: none;"><i class="fas fa-arrow-up"></i></button>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // í–„ë²„ê±° ë©”ë‰´ í† ê¸€
      const menuToggle = document.querySelector('.menu-toggle');
      const mainNav = document.querySelector('.main-nav');
      
      if (menuToggle) {
        menuToggle.addEventListener('click', function() {
          mainNav.classList.toggle('active');
          menuToggle.classList.toggle('active');
        });
      }
      
      // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
      const header = document.querySelector('header');
      
      window.addEventListener('scroll', function() {
        if (window.scrollY > 50) {
          header.classList.add('scrolled');
        } else {
          header.classList.remove('scrolled');
        }
        
        // ìœ„ë¡œ ê°€ê¸° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
        const backToTopButton = document.getElementById("back-to-top");
        if (window.scrollY > 300) {
          backToTopButton.style.display = "block";
        } else {
          backToTopButton.style.display = "none";
        }
      });
      
      // ë‹¤í¬ëª¨ë“œ/ë¼ì´íŠ¸ëª¨ë“œ ê°ì§€ ë° ì²˜ë¦¬
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark-mode');
      }
      
      // ë¡œê·¸ì¸ í•„ìš” ë¶ë§ˆí¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.querySelectorAll('.need-login').forEach(btn => {
        btn.addEventListener('click', function() {
          alert('ë¶ë§ˆí¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
        });
      });
      
      // ë¶ë§ˆí¬ ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.querySelectorAll('.add-bookmark').forEach(btn => {
        btn.addEventListener('click', function() {
          const repoName = this.dataset.name;
          const button = this;
          
          fetch('/add_bookmark', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ repo_name: repoName })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
              button.innerHTML = '<i class="fas fa-bookmark"></i> ë¶ë§ˆí¬ ì‚­ì œ';
              button.classList.remove('add-bookmark');
              button.classList.add('remove-bookmark');
              button.dataset.id = data.bookmark_id;
              
              // ìƒˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ í•„ìš”
              setupRemoveListener(button);
              
              alert('ë¶ë§ˆí¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
              alert(data.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .catch(error => {
            console.error('ë¶ë§ˆí¬ ì¶”ê°€ ì˜¤ë¥˜:', error);
            alert('ë¶ë§ˆí¬ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
        });
      });
      
      // ë¶ë§ˆí¬ ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      function setupRemoveListener(button) {
        button.addEventListener('click', function() {
          const bookmarkId = this.dataset.id;
          const button = this;
          
          fetch(`/bookmark/${bookmarkId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
              button.innerHTML = '<i class="far fa-bookmark"></i> ë¶ë§ˆí¬ ì¶”ê°€';
              button.classList.remove('remove-bookmark');
              button.classList.add('add-bookmark');
              button.dataset.name = button.closest('.card').querySelector('h2 a').textContent;
              delete button.dataset.id;
              
              alert('ë¶ë§ˆí¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
              alert(data.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .catch(error => {
            alert('ë¶ë§ˆí¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
        });
      }
      
      document.querySelectorAll('.remove-bookmark').forEach(setupRemoveListener);
      
      // ëŒ“ê¸€ í† ê¸€ ê¸°ëŠ¥
      document.querySelectorAll('.comment-toggle').forEach(button => {
        if (!button.classList.contains('need-login')) {
          const repoId = button.dataset.repoId;
          const commentsSection = document.getElementById(`comments-${repoId}`);
          
          button.addEventListener('click', function() {
            if (commentsSection.style.display === 'none') {
              // ëŒ“ê¸€ ì„¹ì…˜ ì—´ê¸°
              commentsSection.style.display = 'block';
              loadComments(repoId);
            } else {
              // ëŒ“ê¸€ ì„¹ì…˜ ë‹«ê¸°
              commentsSection.style.display = 'none';
            }
          });
        }
      });
      
      // ëŒ“ê¸€ ë¡œë”© í•¨ìˆ˜
      function loadComments(repoId) {
        const commentsSection = document.getElementById(`comments-${repoId}`);
        const commentsList = commentsSection.querySelector('.comments-list');
        
        // ì´ë¯¸ ë¡œë”©ëœ ê²½ìš° ìŠ¤í‚µ
        if (!commentsList.querySelector('.loading-comments')) {
          return;
        }
        
        fetch(`/comments/${repoId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              updateCommentCount(repoId, data.comments.length);
              
              commentsList.innerHTML = '';
              
              if (data.comments.length === 0) {
                commentsList.innerHTML = '<div class="no-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</div>';
              } else {
                data.comments.forEach(comment => {
                  const commentElement = createCommentElement(comment);
                  commentsList.appendChild(commentElement);
                });
              }
            } else {
              commentsList.innerHTML = '<div class="comment-error">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
              console.error('ëŒ“ê¸€ ë¡œë”© ì˜¤ë¥˜:', data.message);
            }
          })
          .catch(error => {
            commentsList.innerHTML = '<div class="comment-error">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            console.error('ëŒ“ê¸€ ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
          });
      }
      
      // ëŒ“ê¸€ ì¶”ê°€ ì´ë²¤íŠ¸
      document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const repoId = this.dataset.repoId;
          const textarea = this.querySelector('textarea');
          const content = textarea.value.trim();
          
          if (content.length < 2) {
            alert('ëŒ“ê¸€ì€ ìµœì†Œ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
          }
          
          fetch('/comments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              repo_id: repoId,
              content: content
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // ì„±ê³µì ìœ¼ë¡œ ëŒ“ê¸€ ì¶”ê°€
              const commentsList = document.getElementById(`comments-${repoId}`).querySelector('.comments-list');
              
              // ì²« ëŒ“ê¸€ì¸ ê²½ìš° ì²˜ë¦¬
              if (commentsList.querySelector('.no-comments')) {
                commentsList.innerHTML = '';
              }
              
              // ìƒˆ ëŒ“ê¸€ ì¶”ê°€
              const commentElement = createCommentElement(data.comment);
              commentsList.appendChild(commentElement);
              
              // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
              const currentCount = parseInt(document.querySelector(`.comment-toggle[data-repo-id="${repoId}"] .comment-count`).textContent);
              updateCommentCount(repoId, currentCount + 1);
              
              // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
              textarea.value = '';
            } else {
              alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            }
          })
          .catch(error => {
            console.error('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜:', error);
            alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
        });
      });
      
      // ëŒ“ê¸€ ìš”ì†Œ ìƒì„± í•¨ìˆ˜
      function createCommentElement(comment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment-item';
        commentDiv.dataset.id = comment.id;
        
        // í˜„ì¬ ì‚¬ìš©ì ID (ì„œë²„ì—ì„œ ë Œë”ë§ ì‹œ ê°’ì´ ì±„ì›Œì§)
        const currentUserId = {{ current_user.id if current_user.is_authenticated else 0 }};
        
        const isMyComment = comment.user_id == currentUserId;
        
        commentDiv.innerHTML = `
          <div class="comment-header">
            <span class="comment-author">${comment.username}</span>
            <span class="comment-date">${comment.created_at}</span>
            ${isMyComment ? '<button class="delete-comment"><i class="fas fa-trash-alt"></i></button>' : ''}
          </div>
          <div class="comment-content">${escapeHtml(comment.content)}</div>
        `;
        
        // ë‚´ ëŒ“ê¸€ì´ë©´ ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€
        if (isMyComment) {
          const deleteBtn = commentDiv.querySelector('.delete-comment');
          deleteBtn.addEventListener('click', function() {
            if (confirm('ì •ë§ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              deleteComment(comment.id, comment.repo_id);
            }
          });
        }
        
        return commentDiv;
      }
      
      // ëŒ“ê¸€ ì‚­ì œ í•¨ìˆ˜
      function deleteComment(commentId, repoId) {
        fetch(`/comments/${commentId}`, {
          method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // ëŒ“ê¸€ ìš”ì†Œ ì‚­ì œ
            const commentElement = document.querySelector(`.comment-item[data-id="${commentId}"]`);
            commentElement.remove();
            
            // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
            const commentsList = document.getElementById(`comments-${repoId}`).querySelector('.comments-list');
            const comments = commentsList.querySelectorAll('.comment-item');
            
            updateCommentCount(repoId, comments.length);
            
            // ëŒ“ê¸€ì´ ì—†ëŠ” ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
            if (comments.length === 0) {
              commentsList.innerHTML = '<div class="no-comments">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</div>';
            }
          } else {
            alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
          }
        })
        .catch(error => {
          console.error('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
          alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      }
      
      // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateCommentCount(repoId, count) {
        const countElement = document.querySelector(`.comment-toggle[data-repo-id="${repoId}"] .comment-count`);
        countElement.textContent = count;
      }
      
      // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      
      // ìœ„ë¡œ ê°€ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      const backToTopButton = document.getElementById("back-to-top");
      backToTopButton.addEventListener("click", function() {
        window.scrollTo({
          top: 0,
          behavior: "smooth"
        });
      });
    });
  </script>
</body>
</html>
